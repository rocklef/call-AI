<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompts Management - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .admin-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .admin-card:hover {
            transform: translateY(-2px);
        }
        .nav-link {
            color: #333;
            border-radius: 10px;
            margin: 0.5rem 0;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }
        .nav-link.active {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
            font-weight: bold;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            min-height: 80vh;
        }
        .prompt-card {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .prompt-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        .prompt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .btn-admin {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            color: white;
            padding: 12px 24px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .textarea-custom {
            min-height: 200px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3">
                <div class="sidebar p-4">
                    <div class="text-center mb-4">
                        <h3 class="fw-bold text-primary">üè• Admin Panel</h3>
                        <p class="text-muted">Smart Appointment System</p>
                    </div>
                    
                    <nav class="nav flex-column">
                        <a class="nav-link" href="/admin">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </a>
                        <a class="nav-link" href="/admin/appointments">
                            <i class="fas fa-calendar-check me-2"></i>
                            Appointments
                        </a>
                        <a class="nav-link" href="/admin/calls">
                            <i class="fas fa-phone me-2"></i>
                            Call Logs
                        </a>
                        <a class="nav-link active" href="/admin/prompts">
                            <i class="fas fa-robot me-2"></i>
                            AI Prompts
                        </a>
                        <hr>
                        <a class="nav-link" href="/">
                            <i class="fas fa-home me-2"></i>
                            Public Site
                        </a>
                    </nav>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="col-md-9">
                <div class="main-content p-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2 class="fw-bold mb-3">
                                <i class="fas fa-robot me-2"></i>
                                AI Prompts Management
                            </h2>
                            <p class="text-muted">Configure how the AI behaves in different scenarios</p>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="admin-card p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="fw-bold mb-0">
                                        <i class="fas fa-plus me-2"></i>
                                        Quick Actions
                                    </h5>
                                    <button class="btn btn-admin" onclick="openNewPromptModal()">
                                        <i class="fas fa-plus me-2"></i>
                                        Add New Prompt
                                    </button>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="text-center p-3">
                                            <i class="fas fa-robot fa-2x text-primary mb-2"></i>
                                            <h6>Active Prompts</h6>
                                            <span class="badge bg-success" id="active-count">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3">
                                            <i class="fas fa-list fa-2x text-info mb-2"></i>
                                            <h6>Total Prompts</h6>
                                            <span class="badge bg-info" id="total-count">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="text-center p-3">
                                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                            <h6>Last Updated</h6>
                                            <small class="text-muted" id="last-updated">-</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prompts List -->
                    <div class="row" id="prompts-container">
                        <div class="col-12 text-center">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Loading prompts...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New/Edit Prompt Modal -->
    <div class="modal fade" id="promptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-title">Add New Prompt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="prompt-form">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scenario-name" class="form-label">Scenario Name</label>
                                    <input type="text" class="form-control" id="scenario-name" required>
                                    <div class="form-text">e.g., "medical", "dental", "emergency", "friendly"</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="make-active" class="form-label">Status</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="make-active">
                                        <label class="form-check-label" for="make-active">
                                            Make this the active prompt
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="prompt-text" class="form-label">System Prompt</label>
                            <textarea class="form-control textarea-custom" id="prompt-text" rows="10" required 
                                placeholder="Enter the system prompt that defines how the AI should behave..."></textarea>
                            <div class="form-text">
                                This prompt will define the AI's personality, tone, and behavior for this scenario.
                            </div>
                        </div>
                        
                        <!-- Prompt Templates -->
                        <div class="mb-3">
                            <label class="form-label">Quick Templates</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadTemplate('medical')">
                                        Medical Professional
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-success btn-sm w-100 mb-2" onclick="loadTemplate('friendly')">
                                        Friendly Assistant
                                    </button>
                                </div>
                                                                <div class="col-md-4">
                                     <button type="button" class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="loadTemplate('emergency')">
                                         Emergency Mode
                                     </button>
                                 </div>
                                 <div class="col-md-4">
                                     <button type="button" class="btn btn-outline-info btn-sm w-100 mb-2" onclick="loadTemplate('laundry')">
                                         Laundry Shop
                                     </button>
                                 </div>
                                 <div class="col-md-4">
                                     <button type="button" class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="loadTemplate('restaurant')">
                                         Restaurant
                                     </button>
                                 </div>
                                 <div class="col-md-4">
                                     <button type="button" class="btn btn-outline-dark btn-sm w-100 mb-2" onclick="loadTemplate('salon')">
                                         Beauty Salon
                                     </button>
                                 </div>
                                 <div class="col-md-4">
                                     <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="loadTemplate('tech')">
                                         Tech Support
                                     </button>
                                 </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePrompt()">Save Prompt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the prompt "<strong id="delete-prompt-name"></strong>"?</p>
                    <p class="text-danger"><small>This action cannot be undone.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allPrompts = [];
        let currentPromptId = null;
        let isEditing = false;

        const promptTemplates = {
            medical: {
                name: "medical",
                text: "You are a professional medical appointment booking assistant. Always maintain a calm, professional tone. Be empathetic but concise. Focus on medical terminology and ensure patients feel heard and understood. Prioritize patient safety and confidentiality. Keep responses clear and medically appropriate."
            },
            friendly: {
                name: "friendly",
                text: "You are a warm and friendly appointment booking assistant. Use a cheerful, approachable tone. Make small talk and show genuine interest in the caller's needs. Use casual language and be very patient. Always end conversations on a positive note."
            },
                         emergency: {
                 name: "emergency",
                 text: "You are an emergency appointment booking assistant. Be direct, efficient, and prioritize urgent cases. Use clear, concise language. Ask specific questions about symptoms and urgency. Maintain calm under pressure and provide immediate assistance."
             },
             laundry: {
                 name: "laundry_shop",
                 text: "You are a helpful laundry shop assistant. Your role is to attend customer calls, collect their laundry details, and inform them about completion status and collection times. Be friendly and professional. Ask for customer name, phone number, type of service (wash, dry, iron, etc.), and any special instructions. When laundry is ready, provide the collection time and any additional information. Always confirm customer details and be helpful with any questions about services or pricing."
             },
             restaurant: {
                 name: "restaurant",
                 text: "You are a restaurant reservation assistant. Help customers book tables, check availability, and provide information about the restaurant. Be warm and welcoming. Ask for party size, preferred date/time, special occasions, and dietary requirements. Confirm reservation details and provide any relevant information about dress code, parking, or special services. Always thank customers and confirm their booking details."
             },
             salon: {
                 name: "beauty_salon",
                 text: "You are a beauty salon appointment assistant. Help clients book appointments for various services like haircuts, styling, treatments, and beauty services. Be friendly and professional. Ask for client name, preferred service, stylist preference, date/time, and any special requirements. Provide information about services, pricing, and duration. Confirm appointment details and remind clients about any preparation needed for their service."
             },
             tech: {
                 name: "tech_support",
                 text: "You are a technical support assistant. Help customers with technical issues, troubleshooting, and product support. Be patient and methodical. Ask for specific details about the problem, device information, and error messages. Provide step-by-step solutions and escalate complex issues when needed. Always confirm if the solution worked and offer additional help if required."
             }
        };

        async function loadPrompts() {
            try {
                const response = await fetch('/api/admin/prompts');
                const data = await response.json();
                allPrompts = data.prompts;
                displayPrompts();
                updateCounts();
            } catch (error) {
                console.error('Error loading prompts:', error);
                document.getElementById('prompts-container').innerHTML = 
                    '<div class="col-12 text-center text-danger">Error loading prompts</div>';
            }
        }

        function displayPrompts() {
            const container = document.getElementById('prompts-container');
            
            if (allPrompts.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="admin-card p-5 text-center">
                            <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                            <h5>No prompts configured</h5>
                            <p class="text-muted">Create your first AI prompt to get started</p>
                            <button class="btn btn-admin" onclick="openNewPromptModal()">
                                <i class="fas fa-plus me-2"></i>
                                Add First Prompt
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            let html = '';
            allPrompts.forEach(prompt => {
                const activeClass = prompt.is_active ? 'active' : '';
                const activeBadge = prompt.is_active ? 
                    '<span class="badge bg-success ms-2">Active</span>' : '';
                
                html += `
                    <div class="col-md-6 mb-4">
                        <div class="admin-card prompt-card ${activeClass} p-4">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="fw-bold mb-1">
                                        <i class="fas fa-robot me-2"></i>
                                        ${prompt.scenario_name}
                                        ${activeBadge}
                                    </h5>
                                    <small class="text-muted">Created: ${new Date(prompt.created_at).toLocaleDateString()}</small>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPrompt('${prompt.scenario_name}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="activatePrompt('${prompt.scenario_name}')" ${prompt.is_active ? 'disabled' : ''}>
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePrompt('${prompt.scenario_name}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="prompt-preview">
                                <p class="text-muted mb-2">Preview:</p>
                                <div class="bg-light p-3 rounded" style="max-height: 100px; overflow: hidden;">
                                    ${prompt.prompt_text.substring(0, 150)}${prompt.prompt_text.length > 150 ? '...' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateCounts() {
            const activeCount = allPrompts.filter(p => p.is_active).length;
            const totalCount = allPrompts.length;
            const lastUpdated = allPrompts.length > 0 ? 
                new Date(Math.max(...allPrompts.map(p => new Date(p.created_at)))).toLocaleDateString() : '-';
            
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('last-updated').textContent = lastUpdated;
        }

        function openNewPromptModal() {
            isEditing = false;
            currentPromptId = null;
            document.getElementById('modal-title').textContent = 'Add New Prompt';
            document.getElementById('scenario-name').value = '';
            document.getElementById('prompt-text').value = '';
            document.getElementById('make-active').checked = false;
            new bootstrap.Modal(document.getElementById('promptModal')).show();
        }

        function editPrompt(scenarioName) {
            const prompt = allPrompts.find(p => p.scenario_name === scenarioName);
            if (!prompt) return;
            
            isEditing = true;
            currentPromptId = prompt.id;
            document.getElementById('modal-title').textContent = 'Edit Prompt';
            document.getElementById('scenario-name').value = prompt.scenario_name;
            document.getElementById('prompt-text').value = prompt.prompt_text;
            document.getElementById('make-active').checked = prompt.is_active;
            new bootstrap.Modal(document.getElementById('promptModal')).show();
        }

        function loadTemplate(templateName) {
            const template = promptTemplates[templateName];
            if (template) {
                document.getElementById('scenario-name').value = template.name;
                document.getElementById('prompt-text').value = template.text;
            }
        }

        async function savePrompt() {
            const scenarioName = document.getElementById('scenario-name').value.trim();
            const promptText = document.getElementById('prompt-text').value.trim();
            const makeActive = document.getElementById('make-active').checked;
            
            if (!scenarioName || !promptText) {
                showAlert('Please fill in all required fields', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/prompts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scenario_name: scenarioName,
                        prompt_text: promptText,
                        make_active: makeActive
                    })
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('promptModal')).hide();
                    showAlert('Prompt saved successfully!', 'success');
                    loadPrompts(); // Reload to get updated data
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Error saving prompt', 'danger');
                }
            } catch (error) {
                console.error('Error saving prompt:', error);
                showAlert('Error saving prompt', 'danger');
            }
        }

        async function activatePrompt(scenarioName) {
            try {
                const response = await fetch('/api/admin/prompts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scenario_name: scenarioName,
                        prompt_text: allPrompts.find(p => p.scenario_name === scenarioName).prompt_text,
                        make_active: true
                    })
                });
                
                if (response.ok) {
                    showAlert('Prompt activated successfully!', 'success');
                    loadPrompts(); // Reload to get updated data
                } else {
                    showAlert('Error activating prompt', 'danger');
                }
            } catch (error) {
                console.error('Error activating prompt:', error);
                showAlert('Error activating prompt', 'danger');
            }
        }

        function deletePrompt(scenarioName) {
            const prompt = allPrompts.find(p => p.scenario_name === scenarioName);
            if (!prompt) return;
            
            document.getElementById('delete-prompt-name').textContent = scenarioName;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        async function confirmDelete() {
            const scenarioName = document.getElementById('delete-prompt-name').textContent;
            
            try {
                const response = await fetch('/api/admin/prompts', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scenario_name: scenarioName
                    })
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    showAlert('Prompt deleted successfully!', 'success');
                    loadPrompts(); // Reload to get updated data
                } else {
                    showAlert('Error deleting prompt', 'danger');
                }
            } catch (error) {
                console.error('Error deleting prompt:', error);
                showAlert('Error deleting prompt', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Load prompts when page loads
        document.addEventListener('DOMContentLoaded', loadPrompts);
    </script>
</body>
</html> 